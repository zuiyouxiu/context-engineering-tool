# CLAUDE.md

此文件为 Claude Code (claude.ai/code) 在此代码库中工作时提供指导。

## 开发命令

### 构建和运行
```bash
npm run build    # 编译 TypeScript 到 build/ 目录并设置可执行权限
npm start        # 从 build/index.js 运行编译后的 MCP 服务器
npm run dev      # 使用 tsx 以开发模式运行新架构 (src/index.ts)
npm run dev:old  # 使用旧版本 (index.ts)
npm run clean    # 清理构建目录
```

### 项目结构 v3.0 (智能提示词+记忆管理)
```
src/
├── tools/                   # 上下文工程MCP工具 ✅
│   ├── feasible-mcp-tools.ts      # 核心MCP工具实现
│   ├── context-analysis-tools.ts  # 项目分析和搜索引导
│   └── memory-management.ts       # 持久化记忆管理系统
├── legacy/                  # 传统功能支持 ✅
│   └── context-templates.ts       # 文档模板
├── utils/                   # 工具函数 ✅
│   └── path-utils.ts              # 路径工具
└── index.ts                 # 主服务器文件 ✅

# 文档和配置
CORE_DESIGN_PHILOSOPHY.md          # 核心设计理念 ✅
test-context-engineering.js        # 综合测试脚本 ✅
CONTEXT_ENGINEERING_IMPLEMENTATION.md  # 实现指南 ✅
package.json                 # 依赖项和脚本
tsconfig.json               # TypeScript 配置
build/                      # 编译输出目录
```

## 架构概览 v3.0 (智能提示词构造+记忆管理)

这是一个基于 **上下文工程理念** 的 **模型上下文协议 (MCP) 服务器**，专注于充分利用AI编程工具的内置能力和实现持久化记忆管理。

### 核心设计思路 ✅

**充分利用AI编程工具（如 AugmentCode、Claude Code）本身的强大能力，MCP工具专注于构造智能提示词来引导AI使用这些内置工具，以及实现基于上下文工程核心理念的持久化记忆管理。**

### 上下文工程核心公式 ✅

**上下文工程 = 提示词 + 用户偏好 + 记忆管理 + 信息检索 + 工具调用**

### v3.0 核心设计原则

1. **不重复造轮子**：AI编程工具已有强大的代码索引、语义搜索、文件操作能力，我们不再重复实现这些功能。

2. **智能引导**：专注于构造智能提示词，引导AI更有效地使用内置工具（Grep、Read、Task、Glob等）。

3. **持久化记忆**：实现真正的记忆管理系统：
   - 短期记忆：会话状态、对话历史
   - 长期记忆：用户偏好、项目知识、技术决策

4. **上下文感知**：基于项目技术栈和用户历史，生成个性化的搜索策略和上下文提示。

5. **无缝集成**：完全兼容现有AI编程工具工作流，只是让它更好，不破坏现有功能。

### MCP 工具实现 v3.0 ✅ (重新设计用于AI被动调用)

服务器提供**3个精简的核心工具**，专门为AI被动调用场景优化：

#### 核心AI调用工具

- **`project-context-loader`** (项目上下文加载器)：当AI需要了解项目背景时立即调用
  - 触发时机：用户询问项目架构、技术栈、功能相关问题
  - 功能：快速加载项目技术背景，为AI提供智能搜索指导
  
- **`memory-assistant`** (记忆助手)：获取用户偏好或保存有价值的解决方案
  - 触发时机：生成代码前获取风格偏好；解决复杂问题后保存经验
  - 功能：智能项目记忆管理，让AI提供个性化开发体验
  
- **`smart-prompt-enhancer`** (智能提示词增强器)：为复杂任务构建增强的工作提示
  - 触发时机：面对多步骤开发任务或复杂技术决策时
  - 功能：生成增强的工作提示，帮助AI更好地理解和执行复杂任务

#### 兼容性工具 (保持向后兼容)

- **`get-context-info`**：读取完整项目上下文信息
- **`update-context-engineering`**：更新上下文工程管理文件  
- **`init-context-engineering`**：初始化项目结构

### AI编程工具内置能力利用

系统设计为引导AI编程工具充分利用其内置能力：

1. **Grep**：强大的代码搜索工具，支持正则表达式
2. **Read**：读取文件内容，支持偏移量和限制
3. **Task**：启动智能代理执行复杂搜索任务
4. **Glob**：快速文件模式匹配工具
5. **WebFetch**：网络内容获取和分析
6. **WebSearch**：网络搜索功能

我们的MCP工具不是替代这些功能，而是提供智能的使用指导和上下文信息。

### 关键实现特点

- **轻量级实现**：基于文件系统操作，不依赖外部API，保护隐私安全
- **智能提示生成**：基于项目上下文和用户记忆，生成针对性的搜索策略
- **持久化记忆**：真正的记忆管理系统，支持短期和长期记忆
- **TypeScript 严格模式**：完整的类型定义和检查
- **模块化设计**：每个功能独立模块，易于扩展和维护

## 在此项目中工作

### MCP 集成
- 发布包名：`context-engineering-tool`
- 服务器名称：`context-engineering-tool`
- 版本：v3.0.0
- 需要适当超时的 MCP 客户端配置（建议 300 秒）

### 代码模式
- 模块化架构，每个模块职责单一
- 用于参数验证的 Zod 模式
- 全程使用 async/await 模式
- 智能格式化和错误处理
- TypeScript 严格类型检查

### v3.0 AI被动调用工作流程 (实际可用)

#### 工作流程重新设计说明
**重要：MCP工具是由AI模型被动调用的，不能等待用户指示。AI需要根据提示词中的指导，智能判断何时调用工具。**

1. **会话初始化**（AI自动判断）：
   - 当用户提出项目相关问题时 → AI立即调用 `project-context-loader`
   - 系统返回项目技术栈和搜索指导

2. **代码生成场景**（AI自动判断）：
   - 用户请求代码生成 → AI先调用 `memory-assistant` 获取代码风格偏好
   - 基于偏好生成符合项目风格的代码
   - 如有价值模式 → AI调用 `memory-assistant` 保存到项目知识库

3. **复杂任务处理**（AI自动判断）：
   - 识别多步骤复杂任务 → AI调用 `smart-prompt-enhancer` 
   - 基于增强提示进行系统性任务处理
   - 完成后保存经验到记忆系统

4. **知识积累**（AI自动执行）：
   - 每次成功解决问题后 → AI自动调用 `memory-assistant` 保存解决方案
   - 系统持续学习项目模式和用户偏好

5. **提示词引导工作流程**：
   - AI根据 `augmentcode提示词_v3.md` 中的决策表判断调用时机
   - 所有工具调用都是AI主动进行，不需要用户明确指示

### 核心优势

1. **不重复造轮子**：充分利用AI工具已有的强大能力
2. **智能引导**：提供针对性的搜索策略和工具推荐
3. **持久记忆**：真正的记忆管理，积累项目知识和用户偏好
4. **上下文感知**：基于项目特点和历史经验提供个性化服务
5. **无缝集成**：完全兼容现有工作流，只是让它更好

### 使用指导 (v3.0 AI被动调用模式)

#### 对于AI编程工具配置：
1. **配置提示词**：将 `augmentcode提示词_v3.md` 内容配置到AI编程工具中
2. **MCP服务器连接**：连接到 `context-engineering-tool` MCP服务器
3. **让AI自动工作**：AI会根据提示词自动判断何时调用MCP工具

#### 对于开发者：
1. **初次使用**：让AI调用 `init-context-engineering` 初始化项目结构
2. **日常协作**：直接与AI对话，AI会自动调用需要的工具
3. **无需手动干预**：所有工具调用都由AI智能判断，用户只需正常提问
4. **系统验证**：使用 `test-context-engineering.js` 脚本验证系统完整性

#### 核心理念：
- **用户只需要正常对话**，AI会自动调用MCP工具获取项目信息和管理记忆
- **AI会主动学习**用户的代码风格和项目偏好
- **每次交互都会积累知识**，让下次对话更智能

### 测试和验证

运行综合测试脚本：
```bash
node test-context-engineering.js
```

该脚本验证：
- MCP服务器构建和启动
- 文件系统功能和项目分析
- 上下文工程目录结构
- 五大组件理论实现
- 构建输出完整性